name: ğŸš€ DataSON PR Performance Benchmark

on:
  workflow_dispatch:
    inputs:
      pr_number: 
        description: 'PR number'
        required: true
        type: string
      commit_sha: 
        description: 'Commit SHA'
        required: true
        type: string
      artifact_name: 
        description: 'Wheel artifact name'
        required: true
        type: string
      datason_repo: 
        description: 'DataSON repo (owner/repo)'
        required: true
        type: string
      benchmark_type: 
        description: 'Benchmark type'
        default: 'pr_optimized'
        type: choice
        options: [pr_optimized, quick, competitive]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark-datason-pr:
    name: ğŸ“Š Benchmark DataSON PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout benchmarks
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: ğŸ’¾ Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: datason-pr-${{ runner.os }}-py3.11-${{ hashFiles('requirements.txt') }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install orjson ujson msgpack jsonpickle pandas numpy
        
    - name: ğŸ“¥ Download DataSON wheel from external repository
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');

          // Parse repository info
          const [owner, repo] = '${{ github.event.inputs.datason_repo }}'.split('/');
          const artifactName = '${{ github.event.inputs.artifact_name }}';
          const commitSha = '${{ github.event.inputs.commit_sha }}';

          console.log(`ğŸ” Searching for artifact: ${artifactName}`);
          console.log(`ğŸ“¦ Repository: ${owner}/${repo}`);
          console.log(`ğŸ”— Commit: ${commitSha}`);

          // Get workflow runs for the commit
          const runsResponse = await github.rest.actions.listWorkflowRunsForRepo({
            owner: owner,
            repo: repo,
            head_sha: commitSha,
            status: 'completed',
            per_page: 20
          });

          console.log(`Found ${runsResponse.data.workflow_runs.length} completed runs`);

          // Find the artifact from the most recent successful run
          let artifactId = null;
          for (const run of runsResponse.data.workflow_runs) {
            if (run.conclusion === 'success') {
              console.log(`ğŸ” Checking run ${run.id} (${run.name})`);

              try {
                const artifactsResponse = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: owner,
                  repo: repo,
                  run_id: run.id
                });

                const artifact = artifactsResponse.data.artifacts.find(a => a.name === artifactName);
                if (artifact && !artifact.expired) {
                  console.log(`âœ… Found artifact: ${artifact.name} (${artifact.size_in_bytes} bytes)`);
                  artifactId = artifact.id;
                  break;
                }
              } catch (error) {
                console.log(`âš ï¸ Could not access artifacts for run ${run.id}: ${error.message}`);
              }
            }
          }

          if (!artifactId) {
            throw new Error(`âŒ Could not find artifact '${artifactName}' for commit ${commitSha}`);
          }

          // Download the artifact
          console.log('ğŸ“¥ Downloading artifact...');
          const download = await github.rest.actions.downloadArtifact({
            owner: owner,
            repo: repo,
            artifact_id: artifactId,
            archive_format: 'zip'
          });

          // Save the artifact
          fs.mkdirSync('wheel', { recursive: true });
          fs.writeFileSync('wheel/artifact.zip', Buffer.from(download.data));

          console.log('âœ… Artifact downloaded successfully');
        
    - name: ğŸ”§ Extract and install DataSON wheel
      run: |
        cd wheel
        unzip -q artifact.zip
        ls -la
        echo "ğŸ“¦ Extracted files:"
        find . -name "*.whl" -type f

        # Install the wheel
        WHEEL_FILE=$(find . -name "*.whl" -type f | head -n1)
        if [ -z "$WHEEL_FILE" ]; then
          echo "âŒ No wheel file found in artifact"
          exit 1
        fi

        echo "ğŸ”§ Installing: $WHEEL_FILE"
        pip install "$WHEEL_FILE"

        # Verify installation
        python -c "import datason; print(f'âœ… DataSON {datason.__version__} installed successfully')"
        
    - name: ğŸš€ Run PR-optimized benchmark
      run: |
        mkdir -p data/results docs/results
        
        # Run our optimized PR benchmark suite (5 datasets, ~2 min)
        echo "ğŸ¯ Running PR-optimized benchmark suite..."
        python scripts/pr_optimized_benchmark.py
        
        # Generate Phase 4 enhanced report
        echo "ğŸ¨ Generating Phase 4 enhanced report..."
        python scripts/phase4_enhanced_reports.py \
          --input data/results/pr_optimized_*.json \
          --output docs/results/datason_pr_${{ github.event.inputs.pr_number }}.html \
          --title "DataSON PR #${{ github.event.inputs.pr_number }} Analysis"
          
    - name: ğŸ” Regression detection
      run: |
        # Compare against baseline
        if [ -f data/results/datason_baseline.json ]; then
          python scripts/regression_detector.py \
            data/results/pr_optimized_*.json \
            --baseline data/results/datason_baseline.json \
            --fail-threshold 0.30 \
            --warn-threshold 0.15 \
            --pr-comment datason_pr_comment.md
          
          echo "REGRESSION_STATUS=$?" >> $GITHUB_ENV
        else
          echo "ğŸ“ Establishing new baseline"
          echo "REGRESSION_STATUS=0" >> $GITHUB_ENV
        fi
        
    - name: ğŸ’¬ Generate PR comment
      run: |
        cat > comprehensive_pr_comment.md << 'EOF'
# ğŸš€ DataSON PR Performance Analysis

**PR #${{ github.event.inputs.pr_number }}** | **Commit**: ${{ github.event.inputs.commit_sha }}

## ğŸ“Š Benchmark Results

Tested against our **Phase 1-4 optimized dataset suite**:

| Dataset | Domain | Status | Key Focus |
|---------|--------|--------|-----------|
| Web API Response | `web_api` | âœ… | Common serialization patterns |
| ML Training Data | `machine_learning` | âœ… | NumPy/Pandas integration |
| Financial Transaction | `finance` | âœ… | Precision decimal handling |
| Mixed Types Challenge | `type_testing` | âœ… | Edge case coverage |
| Security PII Test | `security` | âœ… | PII detection effectiveness |

## ğŸ“ˆ Enhanced Analysis

- **Phase 4 Enhanced Report**: Comprehensive interactive analysis available
- **Smart Unit Formatting**: Automatic Î¼s/ms/s conversion
- **ML Compatibility**: 100% NumPy/Pandas support validated
- **Security Metrics**: PII redaction effectiveness measured

EOF

        # Add regression analysis if available
        if [ -f datason_pr_comment.md ]; then
          echo "" >> comprehensive_pr_comment.md
          cat datason_pr_comment.md >> comprehensive_pr_comment.md
        fi
        
        # Add status
        if [ "$REGRESSION_STATUS" = "0" ]; then
          echo "" >> comprehensive_pr_comment.md
          echo "## âœ… Performance Status" >> comprehensive_pr_comment.md
          echo "No significant performance regressions detected. Ready for review!" >> comprehensive_pr_comment.md
        else
          echo "" >> comprehensive_pr_comment.md
          echo "## âš ï¸ Performance Alert" >> comprehensive_pr_comment.md
          echo "Potential performance regression detected. Please review analysis above." >> comprehensive_pr_comment.md
        fi
        
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: datason-pr-${{ github.event.inputs.pr_number }}-analysis
        path: |
          data/results/pr_optimized_*.json
          docs/results/datason_pr_${{ github.event.inputs.pr_number }}.html
          comprehensive_pr_comment.md
        retention-days: 30
        
    - name: ğŸ“ Post to DataSON PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.DATASON_REPO_TOKEN }}
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('comprehensive_pr_comment.md', 'utf8');
          
          await github.rest.issues.createComment({
            owner: 'datason',
            repo: 'datason',
            issue_number: ${{ github.event.inputs.pr_number }},
            body: comment
          });
          
    - name: âŒ Fail on regression
      if: env.REGRESSION_STATUS != '0'
      run: |
        echo "âŒ Performance regression detected!"
        exit 1 