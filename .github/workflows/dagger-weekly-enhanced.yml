name: ğŸ—“ï¸ Enhanced Weekly Benchmarks (Dagger)

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2:00 AM UTC (matches legacy)
  workflow_dispatch:
    inputs:
      full_analysis:
        description: 'Run full competitive analysis'
        required: false
        default: true
        type: boolean
      test_all_configs:
        description: 'Test all DataSON configurations'
        required: false
        default: true
        type: boolean
      parallel_execution:
        description: 'Enable parallel stage execution'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

env:
  DATASON_VERSION: "latest"
  PYTHON_VERSION: "3.12"
  PYTHONUNBUFFERED: 1
  CI: true
  GITHUB_ACTIONS: true

jobs:
  enhanced-weekly-benchmarks:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Extended timeout for comprehensive weekly analysis
    name: ğŸ¯ Enhanced weekly comprehensive benchmarks
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ’¾ Cache Dagger and comprehensive dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/bin/dagger
          key: dagger-weekly-deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'requirements-dagger.txt') }}-${{ github.run_id }}
          restore-keys: |
            dagger-weekly-deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'requirements-dagger.txt') }}-
            dagger-weekly-deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
          
      - name: ğŸ“¦ Install Dagger and comprehensive dependencies
        run: |
          # Install Dagger CLI
          curl -fsSL https://dl.dagger.io/dagger/install.sh | BIN_DIR=$HOME/.local/bin sh
          export PATH="$HOME/.local/bin:$PATH"
          
          # Install comprehensive Python dependencies for weekly analysis
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dagger-io
          
          # Additional dependencies for comprehensive weekly analysis
          pip install faker numpy pandas cbor2 pickle5 dill cloudpickle
          
          echo "âœ… Comprehensive dependencies installed for weekly analysis"
        
      - name: ğŸ¯ Run Enhanced Weekly Benchmarks with Dagger
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ğŸš€ Starting enhanced weekly comprehensive benchmarks..."
          echo "ğŸ“Š Configuration: full_analysis=${{ github.event.inputs.full_analysis || 'true' }}, test_all_configs=${{ github.event.inputs.test_all_configs || 'true' }}, parallel=${{ github.event.inputs.parallel_execution || 'true' }}"
          
          dagger call weekly-benchmarks-full \
            --source=. \
            --full-analysis=${{ github.event.inputs.full_analysis || 'true' }} \
            --test-all-configs=${{ github.event.inputs.test_all_configs || 'true' }} \
            --parallel-execution=${{ github.event.inputs.parallel_execution || 'true' }}
        env:
          DAGGER_CLOUD_TOKEN: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DATASON_VERSION: ${{ env.DATASON_VERSION }}
          
      - name: ğŸ“Š Generate comprehensive weekly summary
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ğŸ“ˆ Generating comprehensive weekly analysis summary..."
          
          # Create enhanced weekly summary with metadata
          cat > weekly_summary.md << 'EOF'
          # Weekly Comprehensive Benchmark Summary
          
          **Date:** $(date -u '+%Y-%m-%d %H:%M UTC')  
          **Run ID:** ${{ github.run_id }}
          **SHA:** ${{ github.sha }}
          **Engine:** Enhanced Dagger Pipeline v1
          
          ## Analysis Configuration
          - **Full Analysis:** ${{ github.event.inputs.full_analysis || 'true' }}
          - **All Configurations:** ${{ github.event.inputs.test_all_configs || 'true' }}
          - **Parallel Execution:** ${{ github.event.inputs.parallel_execution || 'true' }}
          
          ## Enhanced Features Delivered
          - âœ… Fresh synthetic test data generation
          - âœ… Parallel stage execution for speed
          - âœ… Comprehensive competitive analysis
          - âœ… Multi-configuration DataSON testing  
          - âœ… Version evolution tracking
          - âœ… Phase 4 enhanced reports with visualizations
          - âœ… Automated result consolidation
          - âœ… GitHub Pages integration
          
          ## Legacy Workflow Parity
          This enhanced weekly analysis replaces the 498-line legacy YAML workflow
          with type-safe Python code, providing identical functionality with
          improved reliability, testability, and maintainability.
          
          **Results:** Available at https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          EOF
          
          echo "âœ… Weekly summary generated"
          
      - name: ğŸŒ Commit enhanced weekly results to repository  
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add comprehensive weekly results
          find data/results -name "weekly_*.json" -exec git add -f {} \; 2>/dev/null || echo "â„¹ï¸ No weekly JSON results to commit"
          find data/results -name "latest_*.json" -exec git add -f {} \; 2>/dev/null || echo "â„¹ï¸ No latest results to commit"
          find data/results -name "ci_*_*.json" -exec git add -f {} \; 2>/dev/null || echo "â„¹ï¸ No CI results to commit"
          find docs/results -name "weekly_*.html" -exec git add -f {} \; 2>/dev/null || echo "â„¹ï¸ No weekly HTML results to commit"
          find docs/results -name "phase4_comprehensive_*.html" -exec git add -f {} \; 2>/dev/null || echo "â„¹ï¸ No Phase 4 reports to commit"
          git add docs/results/index.html 2>/dev/null || echo "â„¹ï¸ No index.html to commit"
          git add weekly_summary.md 2>/dev/null || echo "â„¹ï¸ No weekly summary to commit"
          
          if ! git diff --staged --quiet; then
            commit_msg="ğŸ“Š Enhanced Weekly Comprehensive Benchmarks (Dagger) - $(date -u '+%Y-%m-%d')

            ğŸ—“ï¸ Weekly Analysis: $(date -u '+%Y-%m-%d %H:%M UTC')
            ğŸ”— Run ID: ${{ github.run_id }}
            ğŸ“ SHA: ${{ github.sha }}
            ğŸš€ Engine: Enhanced Dagger Pipeline v1
            
            ğŸ“Š Analysis Configuration:
            â€¢ Full Analysis: ${{ github.event.inputs.full_analysis || 'true' }}
            â€¢ All Configurations: ${{ github.event.inputs.test_all_configs || 'true' }}  
            â€¢ Parallel Execution: ${{ github.event.inputs.parallel_execution || 'true' }}
            
            âœ¨ Enhanced Features Delivered:
            â€¢ ğŸ”„ Fresh synthetic test data generation
            â€¢ âš¡ Parallel stage execution (matches 498-line legacy workflow)
            â€¢ ğŸ† Comprehensive competitive analysis across all libraries
            â€¢ ğŸ”§ Multi-configuration DataSON optimization testing
            â€¢ ğŸ“ˆ Version evolution tracking with historical comparison
            â€¢ ğŸ“Š Phase 4 enhanced reports with interactive visualizations
            â€¢ ğŸ“‹ Automated result consolidation and summary generation
            â€¢ ğŸŒ GitHub Pages integration with comprehensive updates
            
            ğŸ¯ Legacy Parity Achievement:
            This enhanced Dagger implementation provides complete feature parity
            with the 498-line legacy YAML workflow while delivering:
            â€¢ Type-safe Python pipeline logic (zero YAML complexity)
            â€¢ Local testability for rapid development
            â€¢ Enhanced error handling and logging
            â€¢ Container-based execution for consistency
            â€¢ Improved maintainability and reliability
            
            Generated by Enhanced Dagger Pipeline v1 - Replacing complex YAML with clean Python"
            
            git commit -m "$commit_msg"
            git push
            echo "âœ… Enhanced weekly results committed to repository"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ğŸ“¤ Upload comprehensive weekly artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: enhanced-weekly-comprehensive-results-${{ github.run_id }}
          path: |
            data/results/weekly_*.json
            data/results/latest_*.json
            data/results/ci_*_*.json  
            docs/results/weekly_*.html
            docs/results/phase4_comprehensive_*.html
            docs/results/index.html
            weekly_summary.md
          retention-days: 180  # Extended retention for weekly comprehensive results

      - name: âœ… Enhanced weekly benchmarks complete
        run: |
          echo "ğŸ‰ Enhanced weekly comprehensive benchmark suite completed successfully!"
          echo ""
          echo "ğŸ“Š Analysis Summary:"
          echo "  â€¢ Full Analysis: ${{ github.event.inputs.full_analysis || 'true' }}"
          echo "  â€¢ All Configurations: ${{ github.event.inputs.test_all_configs || 'true' }}"
          echo "  â€¢ Parallel Execution: ${{ github.event.inputs.parallel_execution || 'true' }}"
          echo ""
          echo "ğŸš€ Enhanced Features Delivered:"
          echo "  âœ… Fresh synthetic test data generation" 
          echo "  âœ… Parallel stage execution for optimal speed"
          echo "  âœ… Comprehensive competitive analysis"
          echo "  âœ… Multi-configuration DataSON testing"
          echo "  âœ… Version evolution with historical tracking"
          echo "  âœ… Phase 4 enhanced reports with visualizations"
          echo "  âœ… Automated result consolidation"
          echo "  âœ… GitHub Pages comprehensive updates"
          echo ""
          echo "ğŸ¯ Legacy Workflow Parity Achieved:"
          echo "  â€¢ 498-line YAML workflow â†’ Type-safe Python pipeline"
          echo "  â€¢ Complex YAML syntax â†’ Zero syntax complexity"  
          echo "  â€¢ Limited local testing â†’ Full local development support"
          echo "  â€¢ Fragile error handling â†’ Robust container-based execution"
          echo ""
          echo "ğŸ”— Results: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"